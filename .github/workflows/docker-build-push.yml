# 工作流名称
name: Build Docker Image and Push to Aliyun

# 触发条件：手动触发 + 主分支推送/合并时触发
on:
  workflow_dispatch:  # 手动触发（可选，方便测试）
  push:
    branches: [ master ]  # 仅监听 main 分支（可改为其他分支如 master）
  pull_request:
    branches: [ master ]  # 可选，PR 到主分支时触发（用于验证构建）

# 工作流任务
jobs:
  build-and-push:
    runs-on: ubuntu-latest  # 运行环境（Ubuntu 最稳定，支持 Docker）
    
    steps:
      # 步骤 1：拉取 Github 仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2：设置 JDK（仅 Java 项目需要，其他项目删除此步骤）
      # - name: Set up JDK 17
      #   uses: actions/setup-java@v4
      #   with:
      #     java-version: '17'
      #     distribution: 'temurin'
      #     cache: maven  # 缓存 Maven 依赖，加速构建

      # # 步骤 3：打包项目（仅 Java 项目需要，其他项目替换为自身打包命令）
      # - name: Build with Maven
      #   run: mvn clean package -DskipTests  # 跳过测试，加速打包

      # 步骤 4：登录阿里云镜像仓库
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3  # Docker 官方登录 Action
        with:
          registry: registry.cn-hangzhou.aliyuncs.com  # 阿里云镜像仓库域名（固定）
          username: ${{ secrets.ALIYUN_AK_ID }}         # 从 Secrets 中读取 AK ID
          password: ${{ secrets.ALIYUN_AK_SECRET }}     # 从 Secrets 中读取 AK Secret

      # 步骤 5：构建 Docker 镜像并推送
      - name: Build and push Docker image
        uses: docker/build-push-action@v5  # Docker 官方构建推送 Action
        with:
          context: .  # 构建上下文（当前目录）
          file: ./Dockerfile  # Dockerfile 路径
          push: true  # 启用推送（true=推送，false=仅构建不推送）
          # 镜像标签（支持多个标签，用逗号分隔）
          tags: |
            ${{ secrets.ALIYUN_REGISTRY }}:latest  # 最新版标签
            ${{ secrets.ALIYUN_REGISTRY }}:${{ github.sha }}  # 用 Git 提交 SHA 作为标签（唯一标识）
            ${{ secrets.ALIYUN_REGISTRY }}:v1.0  # 自定义版本标签（可按需修改）
